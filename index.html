<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø·Ø±Ù†Ø¬ Ø§Ø³ØªØ§Ø¯ - Chess Master Ø¨Ø§ Lichess AI</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://unpkg.com/chess.js@1.0.0-beta.6/chess.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #0f0f23, #1a1a2e); color: #fff; margin: 0; padding: 10px; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        #board { width: 100%; max-width: 600px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .sidebar { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; max-width: 400px; width: 100%; }
        .btn { background: linear-gradient(45deg, #667eea, #764ba2); border: none; color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; transition: all 0.3s; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        .btn.active { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .status { text-align: center; font-size: 18px; font-weight: bold; margin: 10px 0; padding: 15px; background: rgba(0,255,0,0.2); border-radius: 8px; }
        #history { max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-family: monospace; font-size: 14px; direction: ltr; text-align: left; }
        #eval { font-size: 24px; text-align: center; margin: 10px 0; font-weight: bold; color: #ffd700; }
        .flex { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        @media (min-width: 768px) { .container { flex-direction: row; } .sidebar { margin-left: 20px; width: auto; } }
        .thinking { opacity: 0.6; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin: 0 0 20px 0; font-size: 2.2em;">â™Ÿï¸ Ø´Ø·Ø±Ù†Ø¬ Ø§Ø³ØªØ§Ø¯ - AI ÙÙˆÙ‚â€ŒØ­Ø±ÙÙ‡â€ŒØ§ÛŒ â™Ÿï¸</h1>
        <div id="board"></div>
        <div class="sidebar">
            <div class="flex">
                <button class="btn" id="newGame">Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯</button>
                <button class="btn" id="flipBoard">ğŸ”„ Ú†Ø±Ø®Ø´ Ø¨ÙˆØ±Ø¯</button>
                <button class="btn" id="resign" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24);">ğŸš© ØªØ³Ù„ÛŒÙ…</button>
            </div>
            <div style="margin-top: 20px;">
                <h3 style="margin: 0 0 10px 0;">Ø³Ø·Ø­ AI:</h3>
                <button class="btn level-btn" data-multi="8">Ù…Ø¨ØªØ¯ÛŒ ğŸ£</button>
                <button class="btn level-btn active" data-multi="4">Ù…ØªÙˆØ³Ø· âš¡</button>
                <button class="btn level-btn" data-multi="2">Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ğŸ”¥</button>
                <button class="btn level-btn" data-multi="1">Ø§Ø³ØªØ§Ø¯ ğŸ’</button>
            </div>
            <div id="status" class="status">Ø´Ù…Ø§ Ø³ÙÛŒØ¯ Ù‡Ø³ØªÛŒØ¯. Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª! â™”</div>
            <div id="eval"></div>
            <div id="timer" style="text-align: center; font-size: 18px; margin: 10px 0;">Ø²Ù…Ø§Ù† Ú©Ù„: 00:00</div>
            <h3>ØªØ§Ø±ÛŒØ®Ú†Ù‡ (PGN):</h3>
            <div id="history"></div>
            <div style="margin-top: 15px; text-align: center; font-size: 14px;">
                <button class="btn" onclick="copyPGN()" style="width: auto; padding: 8px 16px; font-size: 14px;">Ú©Ù¾ÛŒ PGN</button>
                | Ø³Ø§Ø®ØªÙ‡ Ø¨Ø§ â¤ï¸ ØªÙˆØ³Ø· Grok | Lichess Cloud AI
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let game = new Chess();
            let board = null;
            let currentMulti = 4;
            let history = [];
            let gameTimer = 0;
            let timerInterval;
            let aiThinking = false;

            // Ø¨ÙˆØ±Ø¯ config - pieceTheme ÙÛŒÚ©Ø³â€ŒØ´Ø¯Ù‡ Ø¨Ù‡ PNG Ø±Ø³Ù…ÛŒ
            const cfg = {
                draggable: true,
                position: 'start',
                orientation: 'white',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                animationDuration: 300,
                showNotation: true
            };
            board = Chessboard('board', cfg);

            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ - Ø¨Ø§ jQuery on
            $('#newGame').on('click', resetGame);
            $('#flipBoard').on('click', function() { board.flip(); updateStatus(); });
            $('#resign').on('click', function() { endGame('ğŸš© Ø´Ù…Ø§ ØªØ³Ù„ÛŒÙ… Ø´Ø¯ÛŒØ¯! AI Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯.'); });
            $('.level-btn').on('click', function() {
                $('.level-btn').removeClass('active');
                $(this).addClass('active');
                currentMulti = parseInt($(this).data('multi'));
            });

            function onDragStart(source, piece) {
                if (aiThinking || game.game_over() || (game.turn() === 'w' && piece.search(/^b/) !== -1) || (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                    return false;
                }
            }

            function onDrop(source, target) {
                const move = game.move({ from: source, to: target, promotion: 'q' });
                if (move === null) return 'snapback';
                history.push(move.san);
                updateHistory();
                board.position(game.fen());
                updateStatus();
                if (game.game_over()) {
                    endGame();
                    return;
                }
                setTimeout(aiMove, 500);
            }

            function onSnapEnd() {
                board.position(game.fen());
            }

            async function aiMove() {
                aiThinking = true;
                $('#status').text('ğŸ¤– AI Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø±...').addClass('thinking');
                $('#board').css('pointer-events', 'none');
                try {
                    const fen = game.fen();
                    const url = `https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(fen)}&multipv=${currentMulti}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.pvs && data.pvs.length > 0) {
                        const randIndex = Math.floor(Math.random() * Math.min(currentMulti, data.pvs.length));
                        const pv = data.pvs[randIndex];
                        const bestUCI = pv.moves[0];
                        if (bestUCI) {
                            const move = game.move({ from: bestUCI.slice(0,2), to: bestUCI.slice(2,4), promotion: 'q' });
                            if (move) {
                                history.push(move.san);
                                updateHistory();
                                board.position(game.fen());
                                let evalText = '';
                                if (pv.mate !== undefined) {
                                    evalText = `M${pv.mate > 0 ? '+' : ''}${pv.mate}`;
                                } else if (pv.cp !== undefined) {
                                    evalText = (pv.cp / 100).toFixed(2);
                                }
                                $('#eval').text(`Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ AI: ${evalText > 0 ? '+' : ''}${evalText}`);
                            }
                        }
                    } else {
                        throw new Error('No PVs');
                    }
                } catch (e) {
                    console.error(e);
                    $('#status').text('Ø®Ø·Ø§ Ø¯Ø± AI! (Ø§ÛŒÙ†ØªØ±Ù†Øª Ú†Ú© Ú©Ù†)').removeClass('thinking');
                    setTimeout(() => aiMove(), 2000);
                }
                aiThinking = false;
                $('#status').removeClass('thinking');
                $('#board').css('pointer-events', 'auto');
                updateStatus();
                if (game.game_over()) endGame();
            }

            function updateStatus() {
                let status = '';
                const turnColor = game.turn() === 'w' ? 'Ø³ÙÛŒØ¯' : 'Ø³ÛŒØ§Ù‡';
                if (game.in_checkmate()) {
                    status = `${turnColor} Ù…Ø§Øª Ø´Ø¯! Ø¨Ø±Ù†Ø¯Ù‡: ${game.turn() === 'w' ? 'Ø³ÛŒØ§Ù‡' : 'Ø³ÙÛŒØ¯'} ğŸ‰`;
                } else if (game.in_draw()) {
                    status = 'ØªØ³Ø§ÙˆÛŒ! ğŸ¤';
                } else {
                    status = `Ù†ÙˆØ¨Øª ${turnColor}`;
                    if (game.in_check()) status += ' - Ú©ÛŒØ´! âš ï¸';
                }
                $('#status').text(status);
            }

            function updateHistory() {
                let html = '';
                for (let i = 0; i < history.length; i += 2) {
                    const num = Math.floor(i / 2) + 1;
                    const whiteMove = history[i] || '';
                    const blackMove = history[i + 1] || '';
                    html += `<div>${num}. ${whiteMove} ${blackMove}</div>`;
                }
                $('#history').html(html);
                $('#history').scrollTop($('#history')[0].scrollHeight);
            }

            function resetGame() {
                game.reset();
                history = [];
                board.start();
                gameTimer = 0;
                updateHistory();
                updateStatus();
                $('#status').text('Ø´Ù…Ø§ Ø³ÙÛŒØ¯ Ù‡Ø³ØªÛŒØ¯. Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª! â™”');
                $('#eval').empty();
                clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
            }

            function updateTimer() {
                gameTimer++;
                const mins = Math.floor(gameTimer / 60).toString().padStart(2, '0');
                const secs = (gameTimer % 60).toString().padStart(2, '0');
                $('#timer').text(`Ø²Ù…Ø§Ù† Ú©Ù„: ${mins}:${secs}`);
            }

            function endGame(message) {
                clearInterval(timerInterval);
                $('#status').text(message || $('#status').text());
                $('#board').css('pointer-events', 'none');
            }

            window.copyPGN = function() {
                navigator.clipboard.writeText(game.pgn({ max_width: 80 }));
                alert('PGN Ú©Ù¾ÛŒ Ø´Ø¯! ğŸ“‹');
            };

            // Ø´Ø±ÙˆØ¹
            resetGame();
        });
    </script>
</body>
</html>
